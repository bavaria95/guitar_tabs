<!DOCTYPE HTML>
<html>
  <head>
    <style>
      body {
        margin: 0px;
        padding: 0px;
      }
    </style>
  </head>

  <body>
    <canvas id="my_canvas" width="1020" height="600"></canvas>

    <script>
      var N_frets = 22;
	  var canvas = document.getElementById('my_canvas');
  	  var context = canvas.getContext('2d');
      var strings_pos = [40, 80, 120, 160, 200, 240];
      var diff_between_strings = 40;
      var strings = [];
      var string_length = 1000;
      var frets_x = frets_precalc();
      var cross_size = 8;
      var notes = [];

      window.requestAnimFrame = (function(callback) {
        return window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.oRequestAnimationFrame || window.msRequestAnimationFrame ||
        function(callback) {
          window.setTimeout(callback, 1000 / 60);
        };
      })();

      function draw_curve(my_curve, thickness) {
        context.beginPath();
        context.moveTo(my_curve.start_x, my_curve.start_y);
        context.quadraticCurveTo(my_curve.control_x, my_curve.control_y, my_curve.end_x, my_curve.end_y);
      	context.lineCap = 'round';
      	context.lineWidth = thickness;
      	context.strokeStyle = '#000000';
        context.stroke();
      }

      function draw_all_strings() {
      	for (var j = 0; j < strings.length; j++)
    		draw_curve(strings[j], j + 1);
      }

      function frets_precalc() {
      	var frets_x = [];
      	for (var i = N_frets; i >= 0; i--)
      		frets_x.push(string_length - (string_length * Math.pow(2, -i/12.0)) + 50);	// offset - 50px
      	return frets_x;
      }

      function draw_frets() {
      	for (var i = 0; i < frets_x.length; i++) {
      		context.beginPath();
      		context.moveTo(frets_x[i], 40);
      		context.lineTo(frets_x[i], 240);
      		context.lineWidth = 1;
      		if (i == N_frets)
      			context.lineWidth = 4;
      		context.strokeStyle = '#000000';
      		context.lineCap = 'butt';
      		context.stroke();
      	}
      }

      function draw_cross(x, y) {	// (x, y) - center point of cross
      	context.beginPath();
      	context.moveTo(x - cross_size + 2, y - cross_size);
      	context.lineTo(x + cross_size - 2, y + cross_size);
      	context.lineWidth = 3;
      	context.strokeStyle = '#ff0000';
      	context.stroke();

      	context.beginPath();
      	context.moveTo(x + cross_size - 2, y - cross_size);
      	context.lineTo(x - cross_size + 2, y + cross_size);
      	context.lineWidth = 3;
      	context.stroke();
      }

      function draw_point(point) {
      	var a = frets_x[N_frets - point.fret];
      	var b;

      	if (point.fret == 0)
      		b = 10;
      	else
      		b = frets_x[N_frets - point.fret + 1];

      	var x = b + (a - b)/2;
      	var y = strings_pos[point.string];

      	draw_cross(x, y);
      	console.log(a, b, x, y);
      }

      function draw_all_points() {
      	for (var i = 0; i < notes.length; i++)
      		draw_point(notes[i])
      }

      function get_mouse_pos(canvas, evt) {
        var rect = canvas.getBoundingClientRect();
        return {
          x: evt.clientX - rect.left,
          y: evt.clientY - rect.top
        }
      }


      function animate(my_curve, canvas, startTime) {

      	if (my_curve.linear_speed < -0.01)
      		return;

      	if (my_curve.linear_speed < 0.5 && Math.abs(my_curve.control_y - my_curve.start_y) < 8) {
      		my_curve.control_y = my_curve.start_y;
      		context.clearRect(0, 0, canvas.width, canvas.height);

      		draw_frets();
      		draw_all_strings();
      		draw_all_points();
      		return;
      	}

        var time = (new Date()).getTime() - startTime;

        var dy = my_curve.linear_speed * time / 1000 * my_curve.sign;

        if ((my_curve.control_y + dy > (my_curve.start_y + my_curve.amplitude*my_curve.sign) && my_curve.sign == 1) || (my_curve.control_y + dy < (my_curve.start_y - my_curve.amplitude) && my_curve.sign == -1)) {
	        	my_curve.linear_speed -= 0.80;
	        	my_curve.sign *= -1;
	        	my_curve.amplitude *= 0.85;
        }
        
    	my_curve.control_y += dy;

        context.clearRect(0, 0, canvas.width, canvas.height);

        draw_frets();
        draw_all_strings();
        draw_all_points();


        requestAnimFrame(function() {
          animate(my_curve, canvas, startTime);
        });
      }

  	for (var i = 0; i < strings_pos.length; i++) {
	  	strings[i] = {
	        start_x: 10,
	        start_y: strings_pos[i],
	        control_x: string_length / 2 + 10,
	        control_y: strings_pos[i],
	        end_x: string_length + 10,
	        end_y: strings_pos[i],
	        sign: 1,
	        linear_speed: 10.0,
	        amplitude: 60
	      };
	}

	draw_frets();
	draw_all_strings();
	draw_all_points();

    function oscillate(i) {

	    strings[i].amplitude = 60;
	    strings[i].linear_speed = 10.0;

		var startTime = (new Date()).getTime();
		animate(strings[i], canvas, startTime);
    }

    function oscillate_all() {
    	for (var i = 0; i < strings.length; i++) 
    		oscillate(i);
    }

    canvas.addEventListener('click', function(evt) {
        var mouse_pos = get_mouse_pos(canvas, evt);
        var x = mouse_pos.x;
        var y = mouse_pos.y;
        var message = 'Mouse position: ' + x + ',' + y;
        if (click_in_neck(x, y)) {
        	// console.log(point_detection(x, y));
        	var point = point_detection(x, y);
        	draw_point(point);
        	notes.push(point);
        	console.log(notes);
	    }
      }, false);

    function click_in_neck(x, y) {
    	return (x > 5 && x < 775 && y > 25 && y < 255);	   // boundary - 5px and 15px
    }

    function string_detection(x, y) {
    	var i;
    	for (i = 0; i < strings_pos.length, y > strings_pos[i]; i++);

    	// let's assume that we'd detect pressing some string at 15px distance
    	if (i == 0)
    		if (Math.abs(y - strings_pos[0]) < 15)
    			return 0;
	    if (i == 6)
	    	if (Math.abs(y - strings_pos[5]) < 15)
	    		return 5;

    	if (Math.abs(y - strings_pos[i - 1]) < 15)
    		return i - 1;
    	if (Math.abs(y - strings_pos[i]) < 15)
    		return i;

	    return -1;
    }

    function fret_detection(x, y) {
    	var i;
    	for (i = 0; i < frets_x.length, x < frets_x[i]; i++);
    	return N_frets - i + 1;
    }

    function point_detection(x, y) {
    	var s = string_detection(x, y);
    	var f = fret_detection(x, y);

	    return {'string': s, 'fret': f};
    }

    function clear_neck() {
    	notes = [];

    	context.clearRect(0, 0, canvas.width, canvas.height);
    	draw_frets();
        draw_all_strings();
    }

    </script>
    <br>
    <button onclick="oscillate(0)">Oscillate first string</button>
    <button onclick="oscillate(1)">Oscillate second string</button>
    <button onclick="oscillate(2)">Oscillate third string</button>
    <button onclick="oscillate(3)">Oscillate fourth string</button>
    <button onclick="oscillate(4)">Oscillate fifth string</button>
    <button onclick="oscillate(5)">Oscillate sixth string</button>
    <br>
    <button onclick="clear_neck()">Clear neck</button>
  </body>
</html>